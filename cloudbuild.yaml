steps:
- name: docker.io/library/python:3.7
  args: ['pip3', 'install', '-r', 'requirements.txt', '--user']
  id: Install dependencies
- name: docker.io/library/python:3.7
  args: ['pip3', 'install', '-r', 'requirements-dev.txt', '--user']
  id: Install dev dependencies
- name: docker.io/library/python:3.7
  entrypoint: bash
  args: ['-c', 'python3 -m pylint --rcfile=test/pylintrc ./src/*.py']
  id: Lint source code
  waitFor: ['Install dependencies']
- name: docker.io/library/python:3.7
  entrypoint: bash
  args: ['-c', 'python3 -m pylint --rcfile=test/pylintrc ./test/sampleData/raspberrypi/*.py']
  id: Lint autogenerated files
  waitFor: ['Install dependencies', 'Install dev dependencies']
- name: docker.io/library/python:3.7
  entrypoint: python
  args: ['-m', 'unittest', 'discover', 'test']
  id: Run unit tests
  waitFor: ['Lint source code', 'Lint autogenerated files', 'Install dev dependencies']
- name: docker.io/library/python:3.7
  entrypoint: python3
  args:
    - 'src/codegen.py'
    - '-t'
    - 'templates/raspberrypi.py'
    - '-t'
    - 'templates/arduino.cpp'
    - '-t'
    - 'templates/arduino.h'
    - '-t'
    - 'templates/kubos.c'
    - '-t'
    - 'templates/cmsis.svd'
    - '-t'
    - 'templates/datasheet.tex'
    - '-o'
    - './build'
    - '-i'
    - 'peripherals/ADS1015.yaml'
    - '-i'
    - 'peripherals/BMP280.yaml'
    - '-i'
    - 'peripherals/LSM303D.yaml'
    - '-i'
    - 'peripherals/MCP4725.yaml'
    - '-i'
    - 'peripherals/MCP9808.yaml'
    - '-i'
    - 'peripherals/TCS3472.yaml'
  id: Sample codegen
artifacts:
  objects:
    # Store generated files in a Cloud Storage bucket with the commit hash as directory
    location: 'gs://cyanobyte-235018-githubci/$SHORT_SHA'
    paths: ['build/com/cyanobyte/*']
